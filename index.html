<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Argumentative Essay Builder</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center p-4 min-h-screen">

    <div id="app" class="bg-white shadow-xl rounded-2xl p-6 sm:p-8 w-full max-w-4xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
            Argumentative Essay Builder
        </h1>
        <p class="text-center text-gray-600 mb-8">
            Follow the prompts below to build your essay step-by-step.
            Your work is automatically saved.
        </p>

        <!-- Loading State -->
        <div id="loading-state" class="text-center text-gray-500 mb-4 hidden">
            <div class="animate-spin inline-block w-6 h-6 border-4 border-dashed rounded-full border-blue-500 border-t-transparent"></div>
            <p class="mt-2">Connecting to storage...</p>
        </div>

        <!-- User ID -->
        <div id="user-id-display" class="text-center text-gray-500 text-sm mb-6 hidden">
            <span class="font-semibold">Your Session ID:</span> <span id="user-id"></span>
        </div>

        <!-- Paragraph Form Container -->
        <div id="paragraph-form" class="space-y-6">
            <!-- This content will be dynamically generated by JavaScript -->
        </div>

        <!-- Final Essay Container -->
        <div id="final-essay-container" class="space-y-6 hidden">
            <h2 class="text-2xl font-semibold text-gray-700 text-center">Your Final Essay</h2>
            <div id="final-essay-text" class="bg-gray-100 p-6 rounded-lg shadow-inner whitespace-pre-wrap leading-relaxed border border-gray-300">
                <!-- Final essay text will appear here -->
            </div>
            <div id="copy-message" class="text-center text-sm font-semibold text-green-600 hidden"></div>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mt-6">
                <button id="copy-btn" class="w-full sm:w-auto px-6 py-3 bg-teal-500 text-white font-bold rounded-lg shadow-md hover:bg-teal-600 transition-colors duration-200">
                    Copy to Clipboard
                </button>
                <button id="back-btn" class="w-full sm:w-auto px-6 py-3 bg-gray-200 text-gray-700 rounded-lg shadow-md hover:bg-gray-300 transition-colors duration-200">
                    Go Back and Edit
                </button>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div id="nav-buttons" class="flex flex-col sm:flex-row justify-between items-center mt-8 space-y-4 sm:space-y-0 sm:space-x-4">
            <button id="prev-btn" class="w-full sm:w-auto px-6 py-3 bg-gray-200 text-gray-700 rounded-lg shadow-md hover:bg-gray-300 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                Previous
            </button>
            <button id="next-btn" class="w-full sm:w-auto px-6 py-3 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition-colors duration-200">
                Next Paragraph
            </button>
            <button id="generate-btn" class="w-full sm:w-auto px-6 py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition-colors duration-200 hidden">
                Generate Final Essay
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Hardcoded data for the essay template and exemplar
        const TEMPLATE_DATA = {
            introduction: [
                "Define the Issue", "Establish the significance", "State your thesis"
            ],
            body_1: [
                "Transition 1.1", "First Reason (TS)", "Transition 1.2", "Counter-claim 1.1", "Transition 1.3", "Evidence 1.1", "Transition 1.4", "Rebuttal / Claim 1.1", "Evidence 1.2", "Elaboration 1.1", "Transition 1.5", "Claim 1.2", "Transition 1.6", "Evidence 1.3", "Elaboration, Link 1.1"
            ],
            body_2: [
                "Transition 2.1", "Second Reason (TS)", "Transition 2.2", "Counter-claim 2.1", "Evidence 2.1", "Transition 2.3", "Rebuttal / Claim 2.1", "Transition 2.4", "Evidence 2.2", "Elaboration, Link 2.1", "Claim 2.2", "Transition 2.5", "Evidence 2.3", "Elaboration, Link 2.2"
            ],
            body_3: [
                "Transition 3.1", "Third Reason (TS)", "Transition 3.2", "Counter-claim 3.1", "Evidence 3.1", "Rebuttal / Claim 3.1", "Evidence 3.2", "Elaboration, Link 3.1", "Claim 3.2", "Evidence 3.3", "Elaboration, Link 3.2"
            ],
            conclusion: [
                "Restate thesis", "Review reasons", "Call to action"
            ]
        };

        const EXEMPLAR_DATA = {
            introduction: [
                "Countless scientists and nature-lovers have the same item on their bucket lists: a visit to the Galapagos Islands. The environmental preserve made famous by Charles Darwin attracts loads of visitors every year.",
                "While this can be great for education and tourism, it puts the sensitive ecosystem at risk.",
                "That is why, even though it offers some local and global benefits, Galapagos tourism should be discouraged because of the severe risks it poses to the environment."
            ],
            body_1: [
                "One risk posed by Galapagos tourism",
                "is the degradation of the physical environment.",
                "It is often argued that ",
                "tourism provides the needed financial support to support and protect and maintain this ecosystem.",
                "Indeed, as passage one states, ",
                "\"tourism in Ecuador ... generates $1.2 billion per year.\"",
                "While this money is undoubtedly useful,",
                "it has stimulated unregulated growth that is polluting a formerly peaceful environment:",
                "“It’s unsustainable. More flights, more hotels, more cars. It's uncontrolled. We talk about ecotourism but in reality it's already showing signs of being mass tourism\" (Passage 2).",
                "Governments and businesses seek growth, so it is natural that a profitable tourist venture will lose sight of its environmental purpose and start to neglect conservation in favor of profit.",
                "What’s more,",
                "the presence of a large human population is harmful to the delicate local flora and fauna.",
                "A constant stream of visitors introduces \"unnatural stressors\" to the wildlife (Passage One).",
                "This is an unacceptable side effect for a place whose entire purpose is the preservation of its natural environment."
            ],
            body_2: [
                "A second problem with tourism on the islands",
                "is the disruption of natural ecosystems.",
                "Proponents of tourism insist that",
                "these educational opportunities are beneficial and promote preservation.",
                "After all, Passage Two makes it clear that",
                "the Galápagos Islands can send visitors home with a \"renewed passion for the preservation of wildlife\" (Passage One).",
                "However,",
                "such passionate feelings about the environment are only useful if the environment is still there to be preserved. ",
                "The current tourist numbers are already causing massive disruptions to the delicate balance of the Galápagos Islands: \"The Islands' ecosystem is not coping with the number of tourists\" (Passage Two).",
                "Additionally, the massive tourist influx ",
                "has caused the introduction of “non-native plants and animals”",
                "that have wreaked havoc on the native species and their food sources (Passage Two).",
                "In short, the high tourist numbers are undoing the very educational benefits that tourism is supposed to create."
            ],
            body_3: [
                "A final problem with tourism is that",
                "it has become more about personal enrichment than about education.",
                "While it is true that",
                "the Galápagos Islands can send visitors home with a \"renewed passion for the preservation of wildlife\" (Passage One).",
                "Education is a noble goal, but the massive number of visitors is evidence that more than just conservationists are making this trip:",
                "“We talk about ecotourism, but…People aren't even coming for the wildlife any more. They just come for a vacation” (Passage Two).",
                "This change in public translates to changes in behaviors.",
                "Now people want to swim with the seals and pose for photos,",
                "reducing “a pristine natural environment” to a mere “place where tourists take ‘selfies’ with giant tortoises” (Passage Two).",
                "If the Galapagos Islands are serious about promoting environmental preservation, they need to make this destination more about science and less about likes."
            ],
            conclusion: [
                "It can clearly be seen that tourism to the Galapagos Islands has become unsustainable and dangerous.",
                "The massive number of visitors poses a threat to plants and animals, and has made the destination more about vacation than conservation.",
                "The economic and educational benefits are still worthwhile, so the most sensible solution would be to impose limits that allow true ecotourism to continue while better protecting the environment. Otherwise, there will be nothing left for visitors to see on these special Ecuadorian islands."
            ]
        };

        const PARAGRAPH_KEYS = ['introduction', 'body_1', 'body_2', 'body_3', 'conclusion'];
        const essayData = {};
        let currentParagraphIndex = 0;
        let db, auth, userId, appId;

        const loadingState = document.getElementById('loading-state');
        const userIdDisplay = document.getElementById('user-id-display');
        const userIdEl = document.getElementById('user-id');
        const paragraphForm = document.getElementById('paragraph-form');
        const finalEssayContainer = document.getElementById('final-essay-container');
        const finalEssayText = document.getElementById('final-essay-text');
        const navButtons = document.getElementById('nav-buttons');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const generateBtn = document.getElementById('generate-btn');
        const copyBtn = document.getElementById('copy-btn');
        const backBtn = document.getElementById('back-btn');
        const copyMessage = document.getElementById('copy-message');

        // Initialize Firebase and set up auth listener
        async function initializeFirebase() {
            loadingState.classList.remove('hidden');
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdEl.textContent = userId;
                        userIdDisplay.classList.remove('hidden');
                        loadData();
                    } else {
                        userId = crypto.randomUUID();
                        try {
                            const __initial_auth_token = typeof window !== 'undefined' && window.__initial_auth_token;
                            if (__initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth error:", error);
                            // Fallback to non-persistent mode
                            renderParagraph();
                        }
                    }
                    loadingState.classList.add('hidden');
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                // Fallback to non-persistent mode
                loadingState.classList.add('hidden');
                renderParagraph();
            }
        }

        // Load data from Firestore
        function loadData() {
            const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'essays', 'draft');
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const loadedData = docSnap.data();
                    Object.assign(essayData, loadedData.content || {});
                }
                renderParagraph();
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                renderParagraph();
            });
        }

        // Save data to Firestore (debounced)
        let saveTimeout;
        function saveData() {
            if (!db || !userId) return;
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'essays', 'draft');
                setDoc(userDocRef, { content: essayData, lastUpdated: new Date() }).catch(error => {
                    console.error("Error saving to Firestore:", error);
                });
            }, 1000);
        }

        // Render the current paragraph form
        function renderParagraph() {
            const paragraphKey = PARAGRAPH_KEYS[currentParagraphIndex];
            const templatePrompts = TEMPLATE_DATA[paragraphKey];
            const exemplarExamples = EXEMPLAR_DATA[paragraphKey];

            paragraphForm.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 capitalize text-center mb-6">
                    ${paragraphKey.replace('_', ' ')}
                </h2>
            `;

            templatePrompts.forEach((prompt, index) => {
                const value = (essayData[paragraphKey] && essayData[paragraphKey][index]) || '';
                const promptHtml = `
                    <div class="bg-gray-100 p-4 rounded-lg shadow-inner">
                        <label class="block text-gray-700 font-medium mb-2">
                            ${prompt}
                        </label>
                        <textarea
                            id="input-${index}"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200"
                            rows="3"
                            placeholder="Enter your text for &quot;${prompt}&quot; here..."
                        >${value}</textarea>
                        <details class="mt-2 text-sm text-gray-500 cursor-pointer">
                            <summary class="font-semibold hover:text-blue-600 transition-colors duration-200">
                                See Example
                            </summary>
                            <p class="mt-1 p-2 bg-gray-200 rounded-md whitespace-pre-wrap">
                                ${exemplarExamples[index]}
                            </p>
                        </details>
                    </div>
                `;
                paragraphForm.innerHTML += promptHtml;
            });

            // Attach event listeners to the new textareas
            document.querySelectorAll('#paragraph-form textarea').forEach(textarea => {
                const index = parseInt(textarea.id.split('-')[1]);
                textarea.addEventListener('input', (e) => {
                    if (!essayData[paragraphKey]) {
                        essayData[paragraphKey] = new Array(templatePrompts.length).fill('');
                    }
                    essayData[paragraphKey][index] = e.target.value;
                    saveData();
                });
            });

            updateNavButtons();
        }

        function updateNavButtons() {
            prevBtn.disabled = currentParagraphIndex === 0;
            const isLastParagraph = currentParagraphIndex === PARAGRAPH_KEYS.length - 1;
            nextBtn.classList.toggle('hidden', isLastParagraph);
            generateBtn.classList.toggle('hidden', !isLastParagraph);
        }

        function handleNext() {
            currentParagraphIndex++;
            renderParagraph();
        }

        function handlePrevious() {
            currentParagraphIndex--;
            renderParagraph();
        }

        function getFinalEssay() {
            let essayText = "";
            PARAGRAPH_KEYS.forEach(key => {
                if (essayData[key]) {
                    essayText += essayData[key].join(' ') + '\n\n';
                }
            });
            return essayText.trim();
        }

        function showFinalEssay() {
            const finalText = getFinalEssay() || "Your essay will appear here once you've completed all the sections.";
            finalEssayText.textContent = finalText;
            paragraphForm.classList.add('hidden');
            navButtons.classList.add('hidden');
            finalEssayContainer.classList.remove('hidden');
        }

        function showForm() {
            finalEssayContainer.classList.add('hidden');
            paragraphForm.classList.remove('hidden');
            navButtons.classList.remove('hidden');
            renderParagraph();
        }

        function copyToClipboard() {
            const essayText = finalEssayText.textContent;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = essayText;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                copyMessage.textContent = 'Essay copied to clipboard!';
                copyMessage.classList.remove('hidden');
            } catch (err) {
                copyMessage.textContent = 'Failed to copy. Please copy manually.';
                copyMessage.classList.remove('hidden');
                console.error('Copy to clipboard failed:', err);
            }
            document.body.removeChild(tempTextArea);
            setTimeout(() => copyMessage.classList.add('hidden'), 3000);
        }

        // Attach event listeners to buttons
        window.addEventListener('load', () => {
            initializeFirebase();
            nextBtn.addEventListener('click', handleNext);
            prevBtn.addEventListener('click', handlePrevious);
            generateBtn.addEventListener('click', showFinalEssay);
            backBtn.addEventListener('click', showForm);
            copyBtn.addEventListener('click', copyToClipboard);
        });

    </script>
</body>
</html>
